<!DOCTYPE html>
<html>
<head>
	<title>Client extractor form</title>
	<script type="text/javascript" src="utils.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/jquery-ui.js"></script>
	<link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/themes/base/jquery-ui.css">
	<link rel="stylesheet" type="text/css" href="http://trirand.com/blog/jqgrid/themes/ui.jqgrid.css">
	<script type="text/javascript" src="http://trirand.com/blog/jqgrid/js/i18n/grid.locale-en.js"></script>
	<script type="text/javascript" src="http://trirand.com/blog/jqgrid/js/jquery.jqGrid.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/easyXDM/2.4.17.1/easyXDM.debug.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/json2/20140204/json2.js"></script>
	<script type='text/javascript' > 
		$(document).ready(function() {
			function getCandidatesDummy(){
				var candidates = [];

				for (var x = 0; x < 50; x++) {
				    candidates.push({
				    	name: 'Z11111111111',
				    	url : 'http://foo.com',
				    	industry: null
				    });
				}
	
				return candidates;
			}

			function getCandidatesActual(html, successFn, errorFn) {
				//var dummyHtml = "Arlie &amp; Company<br> Frontier Land<br> Hull &amp; Associates<br> Palisades Group<br> Tucci Investments<br> Banfield Properties<br> G Group";

	            url = 'http://localhost:5000/getCandidates';
                var payLoad = {
	                html: html
	            };

	            $.ajax({
	                type: 'POST',
	                url: url,
	                data: JSON.stringify(payLoad),
	                dataType: "json",
	                contentType: "application/json; charset=UTF-8"
	            }).done(function(data) {
	                console.log('success');
	                console.log(data);
	                successFn(data);
	            }).fail(function() {
	                console.log('fail');
	                errorFn();
	            });
			}

			function setupGrid(companies) { 
				$("#grid").jqGrid({
				    datatype: "local",
				    height: 250,
				    colNames: ['Name', 'Website', 'Industry'],
				    colModel: [{
				        name: 'name',
				        index: 'name',
				        width: 150,
				        editable: true,
				        edittype: "text",        
				     },
				     {
				        name: 'website',
				        index: 'website',
				        width: 100,
				        editable: true,
				        edittype: "text",        
				     },
				     {
				        name: 'industry',
				        index: 'industry',
				        width: 100,
				        editable: true,
				        edittype: "text",        
				     }

				    ],
				    caption: "Scraped candidates",
				    onSelectRow: editRow,
				});

				var lastSelection;

				function editRow(id) {
				    if (id && id !== lastSelection) {
				        var grid = $("#grid");
				        grid.jqGrid('restoreRow',lastSelection);
				        grid.jqGrid('editRow',id, {keys:true, focusField: 1});
				        lastSelection = id;
				    }
				}

				console.log(companies);
				for (var i = 0; i <= companies.length; i++) {
				    $("#grid").jqGrid('addRowData', i + 1, companies[i]);
				}
			}

			console.log(window.parseQueryStringToDict);
			console.log(window.getQueryStringParameter);

			parameters = window.getClientFormParameters();
			console.log(parameters);
			$('#sheet-name').text(sheet_name);

			// Get the current selected HTML
		    var rpc = new easyXDM.Rpc({
		    	/**
                 * Register the url to the remote interface
                 * @field
                 */
                local: window.location.origin + "/candidates.html",
                remote: window.location.origin + "/easyxdm_source.html"
		    },
		    {
		        remote: {
		            getParentHtml:{
		                // here we tell the Rpc object to stub a method helloWorld for us
		            }
		        }
			});

		    function getCandidatesFromCurrentSelection(successFn, errorFn) {
				rpc.getParentHtml(function(html){
	                 alert("Got html from parent window " + html);
	     			getCandidatesActual(html, successFn, errorFn);
	     		});
		    }

		    function convertToGridData(apiData) {
		    	var candidates = apiData.candidates;
				// success
				var gridData = []
				for (var idx = 0; idx < candidates.length; idx++) {
					gridData.push({
						'name' : candidates[idx],
						'url' : '',
						'industry' : null
					})
				}
				return gridData;
		    }

			function enableSubmitBtn() {
				$('#submit-clients-btn').attr("disabled", false);
			}
			function disableSubmitBtn() {
				$('#submit-clients-btn').attr("disabled", true);
			}

		    getCandidatesFromCurrentSelection(function(data) {
		    		gridData = convertToGridData(data);
					setupGrid(gridData);
				}, function() {
					// error 	
					alert('No candidates found');			
				});

		    var statusLogger = new function() {
			    this.appendStatus = function appendStatus(msg) {
			    	current = $(".status-messages").val();
			    	current = current + "\n";
			    	new_text = current + msg;  
			    	$(".status-messages").val(new_text);
				};

			    this.clearStatus = function clearStatus(msg) {
			    	$(".status-messages").val("");
				};
			}

		    $('#import-clients-btn').click(function(evt) {
		    		evt.preventDefault();
				    getCandidatesFromCurrentSelection(function(data) {
			    		gridData = convertToGridData(data);
						setupGrid(gridData);
					}, function() {
						// error 	
						alert('No candidates found');			
					});
				});

		    $('#clear-clients-btn').click(function(evt) {
		    		evt.preventDefault();
		    		$('#grid').jqGrid('clearGridData');
				});

		    $('#client-form').submit(function(evt){
		    	disableSubmitBtn();
		    	evt.preventDefault();
		    	//Get data from jqGrid
		    	var allRowsInGrid = $('#grid').jqGrid('getGridParam','data');
		    	console.log( allRowsInGrid.length + ' clients available');

				var validRows = allRowsInGrid.filter(function(index, client) { return client.name != ''; })
		    	// Convert (basically remove the id)

		    	function clean(text) {
		    		return (typeof(text) != 'undefined' && text != null && text != ''? text : '');
		    	}

				var clientsData = validRows.map(function(client, index) {
					return {
						name: client.name,
						website: clean(client.website),
						industry: clean(client.industry),
					}
				});

		    	var payLoad = {
		    		sourceUrl : source_url,
		    		reviewer : reviewer,
		    		sheetName : sheet_name,
		    		clients : clientsData
		    	};

		    	window.qudos_submitClients(payLoad, 
		    		statusLogger,
			    	function() {
			    		//success function
			    	}, function() {
			    		//error function
			    	}, function() {
			    		//always function
			    		enableSubmitBtn();
			    	}
		    	)

		    	/*
				// Doing this because the original clients info is a JQuery selector list and cannot be JSON stringified easily
			    var payload_clients_info = new Array();
				for (var i =0 ; i < clients_info.length; i++ ) { 
					payload_clients_info[i] = clients_info[i]; 
				} */

				// Call submit

		    });

		});
	</script>
	<style type="text/css">
		body {
			background: #eee;
			margin: 0;
			padding: 0;
			font: 18px/24px Georgia, Serif;
			color: #555;
		}

		#sheet-name {
			font-style: italic;
			color: blue;
		}
	</style>
</head>

<body>
	<p> Sheet Name :
		<span id="sheet-name"></span>
	</p>
	<div class="input-area">
		<form id="client-form" action="">
			<table id="grid"></table>
		    <button type="submit" id="submit-clients-btn">Submit clients</button>
		</form>
		<table>
			<tbody>
				<tr>
					<td>		    
						<button id="clear-clients-btn">Clear All</button>
					</td>
					<td>		    
						<button id="import-clients-btn" title="This will append the grid with candidates from HTML">Import HTML</button>
					</td>
				</tr>
			</tbody>
		<table>
	</div>
	<div class="status-section" style="width: 80%">
		<p>Submission Status </p>
		<textarea class="status-messages" rows="4" cols="50">
		</textarea>	
	</div>
</body>